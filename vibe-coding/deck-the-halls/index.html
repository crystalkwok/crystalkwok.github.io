<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Heroic Rocker: Deck the Halls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --primary: #22d3ee; /* Cyan */
            --secondary: #f472b6; /* Pink */
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--bg);
            color: #fff;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .font-bungee { font-family: 'Bungee', cursive; }

        /* Screens */
        .screen {
            position: absolute; inset: 0; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; z-index: 10;
        }
        .screen.active { display: flex; }

        /* Grid Background */
        .bg-grid {
            position: absolute; inset: 0; opacity: 0.15; pointer-events: none;
            background-image: linear-gradient(to right, #333 1px, transparent 1px),
                              linear-gradient(to bottom, #333 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
        }

        /* Lane Visuals */
        .lane-trigger {
            width: 72px; height: 72px; border-radius: 9999px; 
            border: 2px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center; 
            padding: 4px; transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer;
            position: relative;
            background: rgba(0,0,0,0.8);
            overflow: hidden;
        }
        
        @keyframes combo-breathing {
            0% { transform: scale(var(--base-scale, 1)); filter: brightness(1); }
            50% { transform: scale(calc(var(--base-scale, 1) * 1.15)); filter: brightness(1.5); }
            100% { transform: scale(var(--base-scale, 1)); filter: brightness(1); }
        }
        .combo-pulse {
            animation: combo-breathing 0.3s infinite ease-in-out;
        }

        .lane-trigger.active {
            background-color: rgba(255,255,255,0.6);
            border-color: #fff !important;
            transform: scale(1.3) !important;
            box-shadow: 0 0 50px #fff !important;
            z-index: 20;
        }

        /* Judgment Animation */
        @keyframes feedback-pop {
            0% { opacity: 0; transform: translate(-50%, -60%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
            100% { opacity: 0; transform: translate(-50%, -40%) scale(0.8); }
        }
        .judge-feedback {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Bungee'; font-size: 3.5rem; font-style: italic;
            pointer-events: none; z-index: 50; opacity: 0;
            text-shadow: 0 0 30px #000;
            white-space: nowrap;
            letter-spacing: -2px;
        }
        .judge-animate { animation: feedback-pop 0.4s ease-out forwards; }

        /* Great Feedback */
        @keyframes float-up-fade {
            0% { transform: translateX(-50%) translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateX(-50%) translateY(-15px) scale(1.5); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-70px) scale(1.2); opacity: 0; }
        }
        .great-feedback {
            position: absolute; bottom: 120%; left: 50%;
            font-family: 'Bungee'; font-size: 28px; color: var(--secondary);
            pointer-events: none; white-space: nowrap;
            animation: float-up-fade 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            text-shadow: 0 0 10px #000, 0 0 20px var(--secondary);
            z-index: 60;
        }

        @keyframes score-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .score-loss { animation: score-shake 0.15s ease-in-out; color: #ff0044 !important; }

        #game-container {
            width: 100%; max-width: 400px; height: 100%; max-height: 800px;
            position: relative; overflow: hidden;
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(15,15,15,1) 100%);
            border-left: 2px solid #333; border-right: 2px solid #333;
        }

        canvas { display: block; width: 100%; height: 100%; }

        #combo-val {
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root" class="h-screen w-screen flex flex-col items-center justify-center relative bg-black overflow-hidden">
        <div class="bg-grid"></div>

        <!-- START SCREEN -->
        <div id="start-screen" class="screen active p-6">
            <div class="space-y-2 mb-10">
                <h1 class="text-7xl md:text-9xl font-bungee text-transparent bg-clip-text bg-gradient-to-b from-amber-400 to-red-500 drop-shadow-[0_0_50px_rgba(251,191,36,0.3)] leading-none uppercase italic">DECK THE<br/>HALLS</h1>
                <p class="text-zinc-400 font-bold tracking-[0.5em] uppercase text-xs pt-4">Slay Bells Rock Edition</p>
            </div>
            
            <div class="bg-zinc-900/40 backdrop-blur-xl p-8 rounded-3xl border border-zinc-800 w-full max-w-sm space-y-8 shadow-2xl mb-10">
                <div class="flex flex-wrap gap-2 justify-center" id="difficulty-btns">
                    <button data-diff="EASY" class="w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-zinc-800 border-zinc-950 text-zinc-500">EASY</button>
                    <button data-diff="MEDIUM" class="w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-amber-500 text-black border-amber-700 shadow-[0_0_25px_rgba(251,191,36,0.4)] scale-105">MEDIUM</button>
                    <button data-diff="HARD" class="w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-zinc-800 border-zinc-950 text-zinc-500">HARD</button>
                    <button data-diff="EXPERT" class="w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-zinc-800 border-zinc-950 text-zinc-500">EXPERT</button>
                </div>
            </div>

            <button id="start-btn" class="px-16 py-8 bg-white text-black font-bungee text-4xl rounded-full shadow-[0_0_60px_rgba(255,255,255,0.4)] hover:scale-110 active:scale-95 transition-all uppercase">ROCK OUT</button>
            
            <div class="mt-10 text-center px-4 text-xl md:text-2xl font-bungee text-white opacity-60 animate-pulse tracking-widest">
                D - F - J - K
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div id="game-container">
                <canvas id="game-canvas"></canvas>
                <div id="judge-box" class="judge-feedback"></div>
                
                <!-- HUD -->
                <div class="absolute top-10 left-10 flex flex-col pointer-events-none text-left">
                    <span class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Score</span>
                    <span id="score-val" class="text-4xl font-bungee text-white">0</span>
                </div>
                <div class="absolute top-10 right-20 flex flex-col items-end pointer-events-none">
                    <span class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Combo</span>
                    <span id="combo-val" class="text-5xl font-bungee text-cyan-400">0x</span>
                </div>

                <!-- CONTROLS -->
                <div class="absolute bottom-10 left-0 w-full flex justify-around px-4 pointer-events-none">
                    <!-- Lane 0: Character circle (Blue Hat) -->
                    <div class="flex flex-col items-center gap-2 pointer-events-auto relative">
                        <div id="lane-0-ui" class="lane-trigger">
                            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFDBAC" /><path d="M5 50 A 45 45 0 0 1 95 50 L 5 50 Z" fill="#2B60DE" /><text x="50" y="38" font-size="26" font-weight="bold" fill="white" text-anchor="middle" font-family="Arial">A</text><circle cx="38" cy="62" r="5" fill="black" /><circle cx="62" cy="62" r="5" fill="black" /></svg>
                        </div>
                        <span class="text-[11px] font-bungee text-white/40">D</span>
                    </div>
                    <!-- Lane 1: Character circle (Visor Guy) -->
                    <div class="flex flex-col items-center gap-2 pointer-events-auto relative">
                        <div id="lane-1-ui" class="lane-trigger">
                            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#C11B17" /><rect x="25" y="35" width="50" height="40" rx="15" fill="#FDD017" /><rect x="33" y="48" width="12" height="6" rx="2" fill="white" /><rect x="55" y="48" width="12" height="6" rx="2" fill="white" /></svg>
                        </div>
                        <span class="text-[11px] font-bungee text-white/40">F</span>
                    </div>
                    <!-- Lane 2: Character circle (Headphones Guy) -->
                    <div class="flex flex-col items-center gap-2 pointer-events-auto relative">
                        <div id="lane-2-ui" class="lane-trigger">
                            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#E41B17" /><path d="M25 45 Q30 35 45 40 Q40 60 25 65 Z" fill="white" stroke="black" stroke-width="4" /><path d="M75 45 Q70 35 55 40 Q60 60 75 65 Z" fill="white" stroke="black" stroke-width="4" /></svg>
                        </div>
                        <span class="text-[11px] font-bungee text-white/40">J</span>
                    </div>
                    <!-- Lane 3: Character circle (Ninja Cat) -->
                    <div class="flex flex-col items-center gap-2 pointer-events-auto relative">
                        <div id="lane-3-ui" class="lane-trigger">
                            <svg viewBox="0 0 100 100"><path d="M25 25 L15 10 L35 20 Z" fill="#111" /><path d="M75 25 L85 10 L65 20 Z" fill="#111" /><circle cx="50" cy="55" r="40" fill="#111" /><path d="M30 50 L42 55 L30 60 Z" fill="white" /><path d="M70 50 L58 55 L70 60 Z" fill="white" /></svg>
                        </div>
                        <span class="text-[11px] font-bungee text-white/40">K</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- OVER SCREEN -->
        <div id="over-screen" class="screen p-8">
            <div class="space-y-2 mb-10">
                <h2 class="text-7xl font-bungee text-amber-500 drop-shadow-[0_0_30px_rgba(251,191,36,0.4)] italic uppercase">ROCK ON!</h2>
                <p class="text-zinc-500 font-bold uppercase tracking-widest text-xs">Performance Review Completed</p>
                <div id="final-level" class="text-sm font-bungee text-cyan-400 mt-2 tracking-widest uppercase">MEDIUM MODE</div>
            </div>
            <div class="grid grid-cols-2 gap-6 w-full max-w-sm mb-6">
                <div class="bg-zinc-900 p-8 rounded-3xl border border-zinc-800 shadow-lg flex flex-col items-center col-span-2">
                    <span class="text-[11px] text-zinc-500 font-bold uppercase tracking-widest">Points</span>
                    <div id="final-points" class="text-6xl font-bungee text-white mt-1">0</div>
                    <div class="text-[10px] text-zinc-600 font-bold uppercase mt-2">Max Possible: <span id="max-possible-score" class="text-zinc-400">0</span></div>
                </div>
                <div class="bg-zinc-900 p-8 rounded-3xl border border-zinc-800 shadow-lg flex flex-col items-center col-span-2">
                    <span class="text-[11px] text-zinc-500 font-bold uppercase tracking-widest">Max Combo</span>
                    <div id="final-combo" class="text-4xl font-bungee text-amber-400 mt-1">0x</div>
                </div>
            </div>
            <div class="flex gap-4 w-full max-w-sm">
                <button id="retry-btn" class="flex-1 py-5 bg-white text-black font-bungee rounded-2xl shadow-xl hover:bg-zinc-100 transition-all uppercase">RETRY</button>
                <button id="menu-btn" class="flex-1 py-5 bg-zinc-800 rounded-2xl font-bungee border border-zinc-700 text-zinc-300 hover:bg-zinc-700 uppercase">MENU</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Heroic Rocker: Deck the Halls (Rock Edition)
         */

        // --- CONFIG ---
        const BPM = 140; 
        const OFFSET = 2000;
        const LANE_KEYS = ['d', 'f', 'j', 'k'];
        const LANE_COLORS = ['#fbbf24', '#f87171', '#34d399', '#60a5fa'];
        
        // Classic lyrics with a punch
        const LYRICS = "DECK THE HALLS WITH BOUGHS OF HOLLY FA LA LA LA LA LA LA LA LA TIS THE SEASON TO BE JOLLY FA LA LA LA LA LA LA LA LA".split(' ');

        const JUDGMENT_LEVELS = {
            EASY: { PERFECT: 100, GOOD: 180, MISS: 250 },
            MEDIUM: { PERFECT: 65, GOOD: 120, MISS: 190 },
            HARD: { PERFECT: 45, GOOD: 95, MISS: 155 },
            EXPERT: { PERFECT: 32, GOOD: 68, MISS: 115 }
        };

        const PENALTY = {
            OFF_BEAT: 25,
            MISSED_NOTE: 60
        };
        
        const CANVAS_W = 400, CANVAS_H = 711;

        // --- GAME STATE ---
        let state = {
            status: 'START',
            difficulty: 'MEDIUM',
            score: 0,
            maxPossibleScore: 0,
            combo: 0,
            maxCombo: 0,
            notes: [],
            startTime: 0,
            lyricIndex: 0
        };

        // --- AUDIO ENGINE ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.master = null;
                this.freqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88]; // C, D, E, F, G, A, B
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.master = this.ctx.createGain();
                    this.master.gain.value = 0.4;
                    this.master.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            }

            playSfx(lane) {
                if (!this.ctx) return;
                const now = this.ctx.currentTime;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = 'sawtooth';
                o.frequency.setValueAtTime(this.freqs[lane % this.freqs.length] * 2, now);
                g.gain.setValueAtTime(0.15, now);
                g.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                o.connect(g); g.connect(this.master);
                o.start(); o.stop(now + 0.1);
            }

            playMiss() {
                if (!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = 'square'; o.frequency.value = 45;
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
                o.connect(g); g.connect(this.master);
                o.start(); o.stop(this.ctx.currentTime + 0.3);
            }

            scheduleSong(notes, onEnd) {
                const now = this.ctx.currentTime;
                const beat = 60 / BPM;

                // Rock Beat Generator
                for (let i = 0; i < 400; i++) {
                    const t = now + (OFFSET / 1000) + (i * beat);
                    
                    // Heavy Kick on every beat
                    const kick = this.ctx.createOscillator();
                    const kickG = this.ctx.createGain();
                    kick.frequency.setValueAtTime(120, t);
                    kick.frequency.exponentialRampToValueAtTime(0.01, t + 0.12);
                    kickG.gain.setValueAtTime(0.4, t);
                    kickG.gain.exponentialRampToValueAtTime(0.01, t + 0.12);
                    kick.connect(kickG); kickG.connect(this.master);
                    kick.start(t); kick.stop(t + 0.12);

                    // Power Snare on 2 and 4
                    if (i % 2 === 1) {
                        const snareSrc = this.ctx.createBufferSource();
                        const bufSize = this.ctx.sampleRate * 0.15;
                        const snareBuf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
                        const d = snareBuf.getChannelData(0);
                        for(let j=0; j<bufSize; j++) d[j] = (Math.random() * 2 - 1) * 0.1;
                        snareSrc.buffer = snareBuf;
                        const snareG = this.ctx.createGain();
                        snareG.gain.setValueAtTime(0.2, t);
                        snareG.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                        snareSrc.connect(snareG); snareG.connect(this.master);
                        snareSrc.start(t);
                    }
                }

                // Melodic Synthesis for Deck the Halls
                notes.forEach(n => {
                    const t = now + (n.time / 1000);
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.type = 'triangle';
                    o.frequency.value = n.freq;
                    g.gain.setValueAtTime(0, t); 
                    g.gain.linearRampToValueAtTime(0.2, t + 0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.8);
                    o.connect(g); g.connect(this.master);
                    o.start(t); o.stop(t + 0.8);
                });

                if (notes.length > 0) {
                    const songEnd = notes[notes.length - 1].time + 5000;
                    setTimeout(onEnd, songEnd);
                }
            }
        }
        const audio = new AudioEngine();

        // --- MELODY GENERATOR ---
        function getMelody() {
            const beat = 60000 / BPM;
            const F = [261, 293, 329, 349, 392, 440, 493, 523]; // Scale frequencies
            
            // Deck the Halls Pattern: G F E D C D E C (notes as indexes 4 3 2 1 0 1 2 0)
            const deckPattern = [
                { f: F[4], b: 0, l: 0 }, { f: F[3], b: 0.75, l: 1 }, { f: F[2], b: 1, l: 2 }, { f: F[1], b: 1.5, l: 3 },
                { f: F[0], b: 2, l: 0 }, { f: F[1], b: 2.5, l: 1 }, { f: F[2], b: 3, l: 2 }, { f: F[0], b: 4, l: 3 },
                // Fa la la la la (1 2 3 4 5 4 3 2 1)
                { f: F[1], b: 5, l: 0 }, { f: F[2], b: 5.25, l: 1 }, { f: F[3], b: 5.5, l: 2 }, { f: F[1], b: 5.75, l: 3 },
                { f: F[2], b: 6, l: 0 }, { f: F[0], b: 6.5, l: 1 }, { f: F[1], b: 7, l: 2 }, { f: F[2], b: 7.5, l: 3 }
            ];

            const cycles = state.difficulty === 'EASY' ? 2 : (state.difficulty === 'MEDIUM' ? 3 : (state.difficulty === 'HARD' ? 5 : 8));
            const notes = [];
            for (let c = 0; c < cycles; c++) {
                const off = c * 16 * beat + OFFSET;
                deckPattern.forEach(p => {
                    if (state.difficulty === 'EASY' && p.b % 1 !== 0) return;
                    
                    notes.push({ id: notes.length, freq: p.f, lane: p.l, time: off + p.b * beat, processed: false });

                    if (state.difficulty === 'MEDIUM' && Math.random() > 0.8) {
                        notes.push({ id: notes.length, freq: p.f, lane: (p.l + 1) % 4, time: off + p.b * beat, processed: false });
                    }

                    if (state.difficulty === 'HARD' || state.difficulty === 'EXPERT') {
                        if (Math.random() > 0.6) {
                            notes.push({ id: notes.length, freq: p.f, lane: (p.l + 2) % 4, time: off + p.b * beat, processed: false });
                        }
                        if (p.b % 2 === 0) {
                            notes.push({ id: notes.length, freq: p.f * 1.5, lane: (p.l + 1) % 4, time: off + (p.b + 0.25) * beat, processed: false });
                        }
                    }
                });
            }
            
            const sortedNotes = notes.sort((a,b) => a.time - b.time);
            state.maxPossibleScore = 100 * (sortedNotes.length * (sortedNotes.length + 1) / 2);
            return sortedNotes;
        }

        // --- VIEW MANAGEMENT ---
        function setScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showJudge(text, color) {
            const box = document.getElementById('judge-box');
            box.innerText = text;
            box.style.color = color;
            box.style.textShadow = `0 0 30px ${color}`;
            box.className = 'judge-feedback judge-animate';
            const newBox = box.cloneNode(true);
            box.parentNode.replaceChild(newBox, box);
        }

        function showGreatFeedback(laneIdx) {
            const container = document.getElementById(`lane-${laneIdx}-ui`).parentElement;
            const el = document.createElement('div');
            el.className = 'great-feedback';
            el.innerText = 'GREAT!';
            container.appendChild(el);
            setTimeout(() => el.remove(), 500);
        }

        function applyScorePenalty(amount) {
            state.score = Math.max(0, state.score - amount);
            const scoreVal = document.getElementById('score-val');
            scoreVal.classList.add('score-loss');
            setTimeout(() => scoreVal.classList.remove('score-loss'), 200);
            updateHud();
        }

        function updateHud() {
            document.getElementById('score-val').innerText = state.score.toLocaleString();
            const comboEl = document.getElementById('combo-val');
            comboEl.innerText = `${state.combo}x`;
            
            const glowIntensity = Math.min(state.combo * 2.5, 65);
            const baseScale = 1 + Math.min(state.combo * 0.007, 0.28);
            
            document.querySelectorAll('.lane-trigger').forEach((el, idx) => {
                if (state.combo > 0) {
                    el.style.boxShadow = `0 0 ${glowIntensity}px ${LANE_COLORS[idx]}`;
                    el.style.borderColor = LANE_COLORS[idx];
                    el.style.setProperty('--base-scale', baseScale);
                    el.style.transform = `scale(${baseScale})`;
                    if (state.combo >= 20) el.classList.add('combo-pulse');
                    else el.classList.remove('combo-pulse');
                } else {
                    el.style.boxShadow = 'none';
                    el.style.borderColor = 'rgba(255,255,255,0.1)';
                    el.style.transform = 'scale(1)';
                    el.classList.remove('combo-pulse');
                }
            });

            comboEl.style.transform = `scale(${1 + Math.min(state.combo * 0.015, 0.9)})`;
            if (state.combo >= 50) {
                comboEl.style.color = '#fbbf24'; 
                comboEl.style.textShadow = '0 0 25px rgba(251,191,36,0.8)';
            } else {
                comboEl.style.color = '#22d3ee';
                comboEl.style.textShadow = 'none';
            }
        }

        // --- CORE GAME ENGINE ---
        function startGame() {
            audio.init();
            state.status = 'PLAYING';
            state.score = 0;
            state.combo = 0;
            state.maxCombo = 0;
            state.lyricIndex = 0;
            state.notes = getMelody();
            state.startTime = performance.now();
            updateHud();
            setScreen('game-screen');
            
            audio.scheduleSong(state.notes, () => {
                if (state.status === 'PLAYING') endGame();
            });

            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = CANVAS_W;
            canvas.height = CANVAS_H;

            function loop(time) {
                if (state.status !== 'PLAYING') return;
                const elapsed = time - state.startTime;
                const laneW = CANVAS_W / 4;
                const targetY = CANVAS_H * 0.82;
                const speed = state.difficulty === 'EXPERT' ? 1.5 : (state.difficulty === 'HARD' ? 1.15 : (state.difficulty === 'MEDIUM' ? 0.95 : 0.6));

                ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);

                for (let i = 0; i < 4; i++) {
                    ctx.strokeStyle = '#222'; ctx.lineWidth = 1;
                    ctx.beginPath(); ctx.moveTo(i * laneW, 0); ctx.lineTo(i * laneW, CANVAS_H); ctx.stroke();
                    ctx.strokeStyle = LANE_COLORS[i] + '33'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(i * laneW + laneW / 2, targetY, 34, 0, Math.PI * 2); ctx.stroke();
                }

                state.notes.forEach(n => {
                    if (n.processed) return;
                    const ny = targetY - (n.time - elapsed) * speed;

                    if (ny > targetY + 110) {
                        n.processed = true;
                        state.combo = 0;
                        showJudge("MISS", "#ef4444");
                        audio.playMiss();
                        applyScorePenalty(PENALTY.MISSED_NOTE);
                        return;
                    }

                    if (ny > -50 && ny < CANVAS_H + 50) {
                        ctx.fillStyle = LANE_COLORS[n.lane];
                        ctx.shadowBlur = 18; ctx.shadowColor = LANE_COLORS[n.lane];
                        const nx = n.lane * laneW + 12, nw = laneW - 24, nh = 26, r = 6;
                        ctx.beginPath();
                        if (ctx.roundRect) ctx.roundRect(nx, ny - 13, nw, nh, r);
                        else ctx.rect(nx, ny - 13, nw, nh);
                        ctx.fill();
                        ctx.shadowBlur = 0;
                    }
                });

                requestAnimationFrame(loop);
            }
            requestAnimationFrame(loop);
        }

        function endGame() {
            state.status = 'GAME_OVER';
            document.getElementById('final-points').innerText = state.score.toLocaleString();
            document.getElementById('max-possible-score').innerText = state.maxPossibleScore.toLocaleString();
            document.getElementById('final-combo').innerText = `${state.maxCombo}x`;
            document.getElementById('final-level').innerText = `${state.difficulty} MODE`;
            
            const levelEl = document.getElementById('final-level');
            levelEl.style.color = state.difficulty === 'EXPERT' ? '#ef4444' : '#22d3ee';
            setScreen('over-screen');
        }

        function handleInput(lane) {
            if (state.status !== 'PLAYING') return;
            const now = performance.now() - state.startTime;

            const ui = document.getElementById(`lane-${lane}-ui`);
            ui.classList.add('active');
            setTimeout(() => ui.classList.remove('active'), 100);

            const potential = state.notes.filter(n => n.lane === lane && !n.processed);
            if (!potential.length) { audio.playSfx(lane); return; }

            const closest = potential.reduce((p, c) => Math.abs(c.time - now) < Math.abs(p.time - now) ? c : p);
            const diff = Math.abs(closest.time - now);
            const judgments = JUDGMENT_LEVELS[state.difficulty];

            if (diff <= judgments.MISS) {
                closest.processed = true;
                let feedbackColor = "#fff", pts = 0, isPenalty = false;

                if (diff <= judgments.PERFECT) { 
                    feedbackColor = "#22d3ee"; pts = 100; audio.playSfx(lane);
                    state.combo++;
                }
                else if (diff <= judgments.GOOD) { 
                    feedbackColor = "#4ade80"; pts = 50; audio.playSfx(lane);
                    state.combo++;
                }
                else { 
                    feedbackColor = "#ef4444"; pts = -PENALTY.OFF_BEAT;
                    isPenalty = true; state.combo = 0; audio.playMiss();
                }
                
                if (!isPenalty) {
                    if (state.combo >= 8) showGreatFeedback(lane);
                    state.score += pts * state.combo;
                    state.maxCombo = Math.max(state.maxCombo, state.combo);
                    const word = LYRICS[state.lyricIndex % LYRICS.length];
                    state.lyricIndex++;
                    showJudge(word, feedbackColor);
                } else {
                    applyScorePenalty(Math.abs(pts));
                    showJudge("OFF!", feedbackColor);
                }
                updateHud();
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('difficulty-btns').addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            state.difficulty = btn.dataset.diff;
            document.querySelectorAll('#difficulty-btns button').forEach(b => {
                b.className = "w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-zinc-800 border-zinc-950 text-zinc-500";
            });
            btn.className = "w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-amber-500 text-black border-amber-700 shadow-[0_0_25px_rgba(251,191,36,0.4)] scale-105";
            if (state.difficulty === 'EXPERT') {
                btn.className = "w-[45%] py-3 rounded-xl font-bungee text-[10px] border-b-4 transition-all duration-200 active:scale-95 bg-red-600 text-white border-red-900 shadow-[0_0_25px_rgba(220,38,38,0.4)] scale-105";
            }
        });

        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('retry-btn').onclick = startGame;
        document.getElementById('menu-btn').onclick = () => setScreen('start-screen');

        window.addEventListener('keydown', e => {
            const idx = LANE_KEYS.indexOf(e.key.toLowerCase());
            if (idx !== -1) handleInput(idx);
        });

        document.querySelectorAll('.lane-trigger').forEach((el, idx) => {
            el.onpointerdown = (e) => { e.stopPropagation(); handleInput(idx); };
        });

        document.getElementById('game-container').onpointerdown = (e) => {
            if (state.status !== 'PLAYING') return;
            const rect = e.currentTarget.getBoundingClientRect();
            const lane = Math.floor((e.clientX - rect.left) / (rect.width / 4));
            if (lane >= 0 && lane < 4) handleInput(lane);
        };
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>